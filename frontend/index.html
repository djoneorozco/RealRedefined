<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>RealRedefined Quiz</title>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f5f5f5;
      margin: 0;
      height: 100vh;
    }
    .card {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-width: 450px;
      width: 100%;
    }
    h1 { margin-top: 0; }
    input, textarea {
      width: 100%;
      font-size: 1rem;
      padding: 0.5rem;
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    textarea { height: 80px; }
    button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      margin-right: 0.5rem;
      cursor: pointer;
    }
    #result {
      margin-top: 1rem;
      padding: 1rem;
      background: #eee;
      border-radius: 4px;
      min-height: 3em;
    }
    #chart-container {
      margin-top: 1.5rem;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>RealRedefined Quiz</h1>

    <label>Area / ZIP code</label>
    <input id="zip" placeholder="e.g. 78046" />

    <label>Your proposed sale price</label>
    <input id="price" type="number" placeholder="e.g. 850000" />

    <label>Additional context or question</label>
    <textarea id="prompt" placeholder="Any other notes…"></textarea>

    <div>
      <button id="btn-test">Test Backend</button>
      <button id="btn-ask">Ask AI</button>
    </div>

    <div id="result"></div>

    <!-- Chart.js canvas -->
    <div id="chart-container" style="display:none;">
      <canvas id="chart-prices" width="400" height="250"></canvas>
    </div>
  </div>

  <script>
    const zipEl    = document.getElementById('zip');
    const priceEl  = document.getElementById('price');
    const promptEl = document.getElementById('prompt');
    const resultEl = document.getElementById('result');
    const chartWrap = document.getElementById('chart-container');
    let priceChart = null;

    document.getElementById('btn-test').onclick = async () => {
      resultEl.textContent = '⏳ Testing…';
      chartWrap.style.display = 'none';
      try {
        const res = await fetch('/api/test');
        const json = await res.json();
        resultEl.textContent = json.msg;
      } catch (err) {
        resultEl.textContent = 'Test failed: ' + err;
      }
    };

    document.getElementById('btn-ask').onclick = async () => {
      const zip    = zipEl.value.trim();
      const price  = priceEl.value.trim();
      const prompt = promptEl.value.trim();

      if (!zip || !price || !prompt) {
        resultEl.textContent = 'Please fill all three fields.';
        return;
      }

      resultEl.textContent = '⏳ Asking AI…';
      chartWrap.style.display = 'none';

      try {
        const res = await fetch('/api/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ zip, price, prompt })
        });
        const json = await res.json();

        if (json.error) {
          resultEl.textContent = 'Error: ' + json.error;
          return;
        }

        // Show AI answer
        resultEl.textContent = json.answer;

        // Draw the price chart
        const [median, listed] = json.charts.prices;
        chartWrap.style.display = 'block';

        // If a chart already exists, destroy it before drawing a new one
        if (priceChart) {
          priceChart.destroy();
        }

        const ctx = document.getElementById('chart-prices').getContext('2d');
        priceChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Median Price', 'Your Price'],
            datasets: [{
              label: '$ USD',
              data: [median, listed],
            }]
          },
          options: {
            scales: {
              y: { beginAtZero: true }
            },
            plugins: {
              legend: { display: false }
            }
          }
        });

      } catch (err) {
        resultEl.textContent = 'Request failed: ' + err;
      }
    };
  </script>
</body>
</html>